ä½ æ˜¯ä¸€ä¸ªä¸“é—¨å¸®åŠ©ç”¨æˆ·æ„å»ºMCPçš„å°åŠ©æ‰‹
# MCPä¸šåŠ¡å±‚æ„å»ºæŒ‡å— (æœ€æ–°ç‰ˆ 2025-06-18)

## ğŸ“ æ ¸å¿ƒç»“æ„

```
src/
â”œâ”€â”€ index.ts          # MCP stdioæ¨¡å¼å…¥å£ï¼ˆæœ¬åœ°ä½¿ç”¨ï¼Œæ¨èï¼‰
â”œâ”€â”€ httpServer.ts     # MCP HTTPæ¨¡å¼å…¥å£ï¼ˆæœåŠ¡å™¨éƒ¨ç½²ï¼‰
â””â”€â”€ tools/            # ä¸šåŠ¡å·¥å…·æ¨¡å—
    â”œâ”€â”€ tool1.ts      # ä¸šåŠ¡å·¥å…·1
    â””â”€â”€ tool2.ts      # ä¸šåŠ¡å·¥å…·2
```

## ğŸ¯ ä¸¤ç§éƒ¨ç½²æ¨¡å¼

### ğŸ“Œ æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | stdio æ¨¡å¼ | HTTP æ¨¡å¼ |
|------|-----------|-----------|
| **é€‚ç”¨åœºæ™¯** | æœ¬åœ°ä½¿ç”¨ | æœåŠ¡å™¨éƒ¨ç½² |
| **å¯åŠ¨æ–¹å¼** | `npx -y your-mcp-package` | `node build/httpServer.js` |
| **é…ç½®å¤æ‚åº¦** | é›¶é…ç½® | éœ€è¦ç«¯å£é…ç½® |
| **ç½‘ç»œè¦æ±‚** | æ— éœ€ç½‘ç»œ | éœ€è¦æš´éœ²ç«¯å£ |
| **æ¨èç”¨é€”** | ä¸ªäººä½¿ç”¨ã€å¿«é€Ÿæµ‹è¯• | ç”Ÿäº§éƒ¨ç½²ã€å¤šç”¨æˆ· |

## ğŸ”§ å…³é”®æ¨¡å—å®ç°

### 1ï¸âƒ£ MCP stdioæ¨¡å¼å…¥å£ (index.ts) â­ æ¨èæœ¬åœ°ä½¿ç”¨

```typescript
#!/usr/bin/env node
/**
 * MCP Server - stdio mode (recommended for local use)
 * Using latest MCP Protocol 2025-06-18
 */

import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import { z } from "zod";

// âœ… å¼•å…¥ä¸šåŠ¡å·¥å…·
import { tool1 } from "./tools/tool1.js";
import { tool2 } from "./tools/tool2.js";

// åˆ›å»º MCP serverï¼ˆä½¿ç”¨æ–°APIï¼‰
const server = new McpServer({
  name: "YourMCP",
  version: "1.0.0",
});

// ğŸ› ï¸ æ³¨å†Œå·¥å…·1ï¼ˆä½¿ç”¨ registerTool æ–°APIï¼‰
server.registerTool(
  tool1.name,
  {
    title: tool1.title,
    description: tool1.description,
    inputSchema: {
      param1: z.string().describe("å‚æ•°1æè¿°"),
      param2: z.string().optional().describe("å‚æ•°2æè¿°ï¼ˆå¯é€‰ï¼‰"),
    },
    outputSchema: {
      success: z.boolean(),
      result: z.string(),
    },
  },
  async (args) => {
    return await tool1.run(args);
  }
);

// ğŸ› ï¸ æ³¨å†Œå·¥å…·2
server.registerTool(
  tool2.name,
  {
    title: tool2.title,
    description: tool2.description,
    inputSchema: {
      param1: z.string().describe("å‚æ•°1æè¿°"),
    },
    outputSchema: {
      success: z.boolean(),
      data: z.any(),
    },
  },
  async (args) => {
    return await tool2.run(args);
  }
);

// ğŸš€ å¯åŠ¨ stdio ä¼ è¾“
async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error("âœ¨ MCP Server (stdio mode)");
  console.error("ğŸ“‹ Protocol Version: 2025-06-18 (Latest)");
  console.error("âœ… Server started successfully\n");
}

main().catch((error) => {
  console.error("âŒ Server error:", error);
  process.exit(1);
});
```

### 2ï¸âƒ£ MCP HTTPæ¨¡å¼å…¥å£ (httpServer.ts) â€” Streamable HTTP (æœ€æ–°)

```typescript
#!/usr/bin/env node
/**
 * MCP Server - Streamable HTTP mode (for server deployment)
 * Using latest MCP Protocol 2025-06-18
 */

import express, { Request, Response } from "express";
import cors from "cors";
import { randomUUID } from "node:crypto";
import "dotenv/config";

import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StreamableHTTPServerTransport } from "@modelcontextprotocol/sdk/server/streamableHttp.js";
import { isInitializeRequest } from "@modelcontextprotocol/sdk/types.js";
import { z } from "zod";

// å¯¼å…¥ä¸šåŠ¡å·¥å…·
import { tool1 } from "./tools/tool1.js";
import { tool2 } from "./tools/tool2.js";

// åˆ›å»º MCP server å®ä¾‹ï¼ˆå¯è·¨è¯·æ±‚å¤ç”¨ï¼‰
function createMCPServer(): McpServer {
  const server = new McpServer({
    name: "YourMCP",
    version: "1.0.0",
  });

  // æ³¨å†Œå·¥å…·1
  server.registerTool(
    tool1.name,
    {
      title: tool1.title,
      description: tool1.description,
      inputSchema: {
        param1: z.string().describe("å‚æ•°1æè¿°"),
        param2: z.string().optional().describe("å‚æ•°2æè¿°ï¼ˆå¯é€‰ï¼‰"),
      },
      outputSchema: {
        success: z.boolean(),
        result: z.string(),
      },
    },
    async (args) => {
      return await tool1.run(args);
    }
  );

  // æ³¨å†Œå·¥å…·2
  server.registerTool(
    tool2.name,
    {
      title: tool2.title,
      description: tool2.description,
      inputSchema: {
        param1: z.string().describe("å‚æ•°1æè¿°"),
      },
      outputSchema: {
        success: z.boolean(),
        data: z.any(),
      },
    },
    async (args) => {
      return await tool2.run(args);
    }
  );

  return server;
}

const app = express();
const PORT = Number(process.env.PORT) || 3000;

// é…ç½® CORS
app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST", "DELETE", "OPTIONS"],
    allowedHeaders: [
      "Content-Type",
      "Accept",
      "Authorization",
      "Mcp-Session-Id",
      "X-Api-Key",
    ],
    exposedHeaders: ["Content-Type", "Mcp-Session-Id"],
  })
);

app.use(express.json({ limit: "10mb" }));

// å­˜å‚¨ transportsï¼ˆæŒ‰ session IDï¼‰
const transports: Record<string, StreamableHTTPServerTransport> = {};

// å¥åº·æ£€æŸ¥
app.get("/health", (_req: Request, res: Response) => {
  res.json({
    status: "healthy",
    transport: "streamable-http",
    protocol: "2025-06-18",
    activeSessions: Object.keys(transports).length,
    name: "YourMCP",
    version: "1.0.0",
    timestamp: new Date().toISOString(),
  });
});

// Streamable HTTP ä¸»ç«¯ç‚¹ï¼šPOST /mcp
app.post("/mcp", async (req: Request, res: Response) => {
  try {
    const sessionId = req.headers["mcp-session-id"] as string | undefined;
    let transport: StreamableHTTPServerTransport;

    if (sessionId && transports[sessionId]) {
      // å¤ç”¨ç°æœ‰ä¼šè¯
      transport = transports[sessionId];
    } else if (!sessionId && isInitializeRequest(req.body)) {
      // æ–°ä¼šè¯åˆå§‹åŒ–
      transport = new StreamableHTTPServerTransport({
        sessionIdGenerator: () => randomUUID(),
        onsessioninitialized: (id) => {
          transports[id] = transport;
          console.log(`âœ… Session initialized: ${id}`);
        },
        onsessionclosed: (id) => {
          delete transports[id];
          console.log(`âŒ Session closed: ${id}`);
        },
        enableJsonResponse: true,
        // æœ¬åœ°å¼€å‘å…³é—­ DNS rebinding ä¿æŠ¤
        // ç”Ÿäº§ç¯å¢ƒåº”å¯ç”¨å¹¶é…ç½® allowedHosts
        enableDnsRebindingProtection: false,
      });

      // æ¸…ç†å…³é—­çš„ transport
      transport.onclose = () => {
        if (transport.sessionId) {
          delete transports[transport.sessionId];
        }
      };

      const server = createMCPServer();
      await server.connect(transport);
    } else {
      // æ— æ•ˆè¯·æ±‚
      return res.status(400).json({
        jsonrpc: "2.0",
        error: {
          code: -32000,
          message: "Bad Request: No valid session ID provided",
        },
        id: null,
      });
    }

    // ä½¿ç”¨æ–° transport API å¤„ç†è¯·æ±‚
    await transport.handleRequest(req, res, req.body);
  } catch (error) {
    console.error("âŒ Error handling MCP request:", error);
    if (!res.headersSent) {
      res.status(500).json({
        jsonrpc: "2.0",
        error: {
          code: -32603,
          message: "Internal server error",
        },
        id: null,
      });
    }
  }
});

// å¤„ç† GET å’Œ DELETE è¯·æ±‚ï¼ˆä¼šè¯ç®¡ç†ï¼‰
const handleSessionRequest = async (req: Request, res: Response) => {
  const sessionId = req.headers["mcp-session-id"] as string | undefined;
  if (!sessionId || !transports[sessionId]) {
    return res.status(400).send("Invalid or missing session ID");
  }

  const transport = transports[sessionId];
  await transport.handleRequest(req, res);
};

// GET è¯·æ±‚ï¼šæœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„é€šçŸ¥ï¼ˆSSEï¼‰
app.get("/mcp", handleSessionRequest);

// DELETE è¯·æ±‚ï¼šä¼šè¯ç»ˆæ­¢
app.delete("/mcp", handleSessionRequest);

// å¯åŠ¨ Streamable HTTP æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`\nğŸš€ MCP Server (Streamable HTTP)`);
  console.log(`ğŸ“‹ Protocol Version: 2025-06-18 (Latest)`);
  console.log(`ğŸ“¡ Listening on: http://localhost:${PORT}`);
  console.log(`ğŸ”— MCP endpoint: http://localhost:${PORT}/mcp`);
  console.log(`ğŸ’š Health check: http://localhost:${PORT}/health`);
  console.log(`\nâš¡ Using McpServer API with registerTool`);
  console.log(`âœ¨ Features: Session management, type-safe validation`);
  console.log(`\nPress Ctrl+C to stop the server\n`);
}).on("error", (error) => {
  console.error("âŒ Server error:", error);
  process.exit(1);
});
```

### 3ï¸âƒ£ ä¸šåŠ¡å·¥å…·æ¨¡æ¿ (tools/tool1.ts) - æœ€æ–°ç‰ˆ

```typescript
/**
 * ä¸šåŠ¡å·¥å…·æ¨¡æ¿
 * å…¼å®¹æœ€æ–° MCP åè®® 2025-06-18
 */

export const tool1 = {
  name: "your_tool_name",
  title: "Your Tool Title",  // æ–°å¢ï¼šUI æ˜¾ç¤ºåç§°
  description: "å·¥å…·åŠŸèƒ½æè¿°ï¼Œæ¸…æ™°è¯´æ˜å·¥å…·çš„ç”¨é€”å’ŒåŠŸèƒ½",
  
  // æ³¨æ„ï¼šparameters ä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼Œæ–°ä»£ç åº”ä½¿ç”¨ Zod schema
  parameters: {
    type: "object",
    properties: {
      param1: {
        type: "string",
        description: "å‚æ•°1æè¿°"
      },
      param2: {
        type: "string", 
        description: "å‚æ•°2æè¿°"
      }
    },
    required: ["param1"]
  },
  
  async run(args: { param1: string; param2?: string }) {
    try {
      // 1ï¸âƒ£ å‚æ•°éªŒè¯
      if (!args.param1) {
        throw new Error("å‚æ•°param1ä¸èƒ½ä¸ºç©º");
      }

      // 2ï¸âƒ£ ä¸šåŠ¡é€»è¾‘å¤„ç†
      const result = await processBusiness(args.param1, args.param2);
      
      // 3ï¸âƒ£ æ ¼å¼åŒ–è¿”å›ï¼ˆæ³¨æ„ä½¿ç”¨ as const ç¡®ä¿ç±»å‹å®‰å…¨ï¼‰
      return {
        content: [{
          type: "text" as const,  // é‡è¦ï¼šä½¿ç”¨ as const
          text: `# ${args.param1} å¤„ç†ç»“æœ\n\n${result}`
        }]
      };
      
    } catch (error: any) {
      return {
        content: [{
          type: "text" as const,
          text: `âŒ å¤„ç†å¤±è´¥: ${error.message}`
        }],
        isError: true,
      };
    }
  }
};

// ä¸šåŠ¡å¤„ç†å‡½æ•°
async function processBusiness(param1: string, param2?: string) {
  // ä½ çš„ä¸šåŠ¡é€»è¾‘
  return "å¤„ç†ç»“æœ";
}
```

### 4ï¸âƒ£ é«˜çº§å·¥å…·ç¤ºä¾‹ - å¸¦ç»“æ„åŒ–è¾“å‡º

```typescript
import { z } from "zod";

export const advancedTool = {
  name: "advanced_tool",
  title: "Advanced Tool",
  description: "å¸¦ç»“æ„åŒ–è¾“å‡ºçš„é«˜çº§å·¥å…·ç¤ºä¾‹",
  
  async run(args: { query: string; limit?: number }) {
    try {
      const data = await fetchData(args.query, args.limit || 10);
      
      // ç»“æ„åŒ–è¾“å‡º
      const output = {
        success: true,
        query: args.query,
        count: data.length,
        results: data,
      };
      
      return {
        content: [{
          type: "text" as const,
          text: JSON.stringify(output, null, 2)
        }],
        // æ–°å¢ï¼šç»“æ„åŒ–å†…å®¹ï¼ˆå¯é€‰ï¼‰
        structuredContent: output,
      };
    } catch (error: any) {
      return {
        content: [{
          type: "text" as const,
          text: `âŒ Error: ${error.message}`
        }],
        isError: true,
      };
    }
  }
};

async function fetchData(query: string, limit: number) {
  // å®ç°æ•°æ®è·å–é€»è¾‘
  return [];
}
```

## ğŸš€ å…³é”®è¦ç‚¹

### âœ… æ–° API å˜åŒ–ï¼ˆ2025-06-18ï¼‰

#### ä»æ—§ API è¿ç§»åˆ°æ–° API

| æ—§ API (2024-11-05) | æ–° API (2025-06-18) | è¯´æ˜ |
|---------------------|---------------------|------|
| `Server` | `McpServer` | æ–°çš„æœåŠ¡å™¨ç±» |
| `setRequestHandler` | `registerTool` | è‡ªåŠ¨åŒ–å·¥å…·æ³¨å†Œ |
| JSON Schema | Zod Schema | ç±»å‹å®‰å…¨éªŒè¯ |
| æ‰‹åŠ¨åè®®å®ç° | `StreamableHTTPServerTransport` | è‡ªåŠ¨åè®®å¤„ç† |

### âœ… å·¥å…·æ³¨å†Œæµç¨‹ï¼ˆæ–°ç‰ˆï¼‰

1. **å®šä¹‰å·¥å…·** â†’ åˆ›å»ºå·¥å…·å¯¹è±¡ (name, title, description, run)
2. **å¯¼å…¥å·¥å…·** â†’ åœ¨ index.ts/httpServer.ts ä¸­å¯¼å…¥
3. **æ³¨å†Œå·¥å…·** â†’ ä½¿ç”¨ `server.registerTool()` ä¸€æ¬¡æ€§æ³¨å†Œ
4. **ç±»å‹éªŒè¯** â†’ ä½¿ç”¨ Zod schema å®šä¹‰è¾“å…¥è¾“å‡ºç±»å‹

### âœ… å·¥å…·è®¾è®¡æ¨¡å¼ï¼ˆæœ€ä½³å®è·µï¼‰

- **ç»Ÿä¸€ç»“æ„**: name + title + description + runæ–¹æ³•
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨ `as const` ç¡®ä¿è¿”å›ç±»å‹æ­£ç¡®
- **å‚æ•°éªŒè¯**: ä½¿ç”¨ Zod schema è¿›è¡ŒéªŒè¯
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„ try-catch å’Œ isError æ ‡å¿—
- **è¿”å›æ ¼å¼**: content æ•°ç»„ + å¯é€‰çš„ structuredContent

### âœ… é¡¹ç›®é…ç½®

#### ğŸ“¦ package.json é…ç½®ï¼ˆæœ€æ–°ç‰ˆï¼‰

```json
{
  "name": "your-mcp-package",
  "version": "1.0.0",
  "description": "Your MCP Server",
  "type": "module",
  "bin": {
    "your-mcp-package": "./build/index.js",
    "your-mcp-package-http": "./build/httpServer.js"
  },
  "files": [
    "build"
  ],
  "scripts": {
    "build": "tsc && node -e \"require('fs').chmodSync('build/index.js', '755'); try{require('fs').chmodSync('build/httpServer.js','755')}catch(e){}\"",
    "prepare": "npm run build",
    "watch": "tsc --watch",
    "dev": "node build/httpServer.js",
    "start:stdio": "node build/index.js",
    "start:http": "node build/httpServer.js"
  },
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.22.0",
    "express": "^4.19.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/node": "^20.11.24",
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "typescript": "^5.3.3"
  }
}
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**
- `"type": "module"` - å¯ç”¨ ES æ¨¡å—
- `"bin"` - å®šä¹‰å¯æ‰§è¡Œå‘½ä»¤ï¼Œä½¿å¾—å¯ä»¥é€šè¿‡ `npx` è°ƒç”¨
- `"files": ["build"]` - å‘å¸ƒæ—¶åªåŒ…å«ç¼–è¯‘åçš„ build ç›®å½•
- `"prepare"` - npm install åè‡ªåŠ¨æ„å»º
- `build` è„šæœ¬ä¸­çš„ `chmodSync` - ä½¿ç¼–è¯‘åçš„æ–‡ä»¶å¯æ‰§è¡Œ
- â­ **SDK ç‰ˆæœ¬**: 1.22.0ï¼ˆæœ€æ–°ï¼‰
- â­ **Zod**: ç±»å‹éªŒè¯åº“ï¼ˆå¿…éœ€ï¼‰

#### ğŸš€ éƒ¨ç½²æ–¹å¼

##### â­ æ–¹å¼1ï¼šstdio æ¨¡å¼ï¼ˆæ¨èæœ¬åœ°ä½¿ç”¨ï¼‰

```bash
# æœ¬åœ°å¼€å‘
npm run build
npm run start:stdio

# é€šè¿‡ npx ä½¿ç”¨ï¼ˆé›¶é…ç½®ï¼‰
npx -y your-mcp-package
```

##### ğŸŒ æ–¹å¼2ï¼šHTTP æ¨¡å¼ï¼ˆæœåŠ¡å™¨éƒ¨ç½²ï¼‰

```bash
# æœ¬åœ°å¼€å‘
npm run build
npm run start:http   # å¯åŠ¨ http://localhost:3000/mcp

# ç”Ÿäº§éƒ¨ç½²
PORT=3000 node build/httpServer.js
```

#### ğŸ“± å®¢æˆ·ç«¯é…ç½®

##### â­ stdio æ¨¡å¼é…ç½®ï¼ˆæ¨èï¼‰

åœ¨ Claude Desktop æˆ–å…¶ä»– MCP å®¢æˆ·ç«¯çš„é…ç½®æ–‡ä»¶ä¸­ï¼š

```json
{
  "mcpServers": {
    "your-mcp-server": {
      "command": "npx",
      "args": ["-y", "your-mcp-package"],
      "env": {
        "API_KEY": "your_api_key_here"
      }
    }
  }
}
```

**é…ç½®è¯´æ˜ï¼š**
- `command`: ä½¿ç”¨ `npx` å‘½ä»¤
- `args`: `["-y", "your-mcp-package"]` - `-y` è¡¨ç¤ºè‡ªåŠ¨ç¡®è®¤å®‰è£…
- `env`: ä¼ é€’ç¯å¢ƒå˜é‡ï¼ˆå¦‚ API keysï¼‰

##### ğŸŒ HTTP æ¨¡å¼é…ç½®

```json
{
  "mcpServers": {
    "your-mcp-server": {
      "type": "streamableHttp",
      "url": "http://localhost:3000/mcp",
      "timeout": 600,
      "headers": {
        "Authorization": "Bearer YOUR_TOKEN"
      }
    }
  }
}
```

#### ğŸ” ç¯å¢ƒå˜é‡ä¸é‰´æƒ

##### stdio æ¨¡å¼ç¯å¢ƒå˜é‡ä¼ é€’

åœ¨å®¢æˆ·ç«¯é…ç½®ä¸­é€šè¿‡ `env` å­—æ®µä¼ é€’ï¼š

```json
{
  "mcpServers": {
    "your-mcp-server": {
      "command": "npx",
      "args": ["-y", "your-mcp-package"],
      "env": {
        "API_KEY": "your_api_key_here",
        "DATABASE_URL": "postgresql://...",
        "CUSTOM_CONFIG": "value"
      }
    }
  }
}
```

åœ¨æœåŠ¡ç«¯ä»£ç ä¸­è¯»å–ï¼š

```typescript
const apiKey = process.env.API_KEY;
const dbUrl = process.env.DATABASE_URL;
```

##### HTTP æ¨¡å¼è‡ªå®šä¹‰è¯·æ±‚å¤´

åœ¨å®¢æˆ·ç«¯é…ç½®ä¸­æ·»åŠ  `headers`ï¼š

```json
{
  "mcpServers": {
    "your-mcp-server": {
      "type": "streamableHttp",
      "url": "http://localhost:3000/mcp",
      "timeout": 600,
      "headers": {
        "Authorization": "Bearer YOUR_TOKEN",
        "X-Api-Key": "your_api_key",
        "X-Tenant-Id": "tenant_123"
      }
    }
  }
}
```

åœ¨æœåŠ¡ç«¯ï¼ˆhttpServer.tsï¼‰ä¸­è¯»å–ï¼š

```typescript
// é…ç½® CORS å…è®¸è‡ªå®šä¹‰ Header
app.use(cors({
  origin: '*',
  methods: ['GET', 'POST', 'DELETE', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type', 'Accept', 'Authorization', 'Mcp-Session-Id',
    'X-Tenant-Id', 'X-Api-Key', 'X-Custom-Header'
  ],
  exposedHeaders: ['Content-Type', 'Mcp-Session-Id']
}));

// åœ¨å¤„ç†é€»è¾‘ä¸­æå– Token
function extractTokenFromHeaders(req: Request): string | undefined {
  const tokenHeader = req.headers['x-api-key'] as string | undefined;
  if (tokenHeader?.trim()) return tokenHeader.trim();
  
  const auth = req.headers['authorization'];
  if (typeof auth === 'string' && auth.toLowerCase().startsWith('bearer ')) {
    return auth.slice(7).trim();
  }
  
  return undefined;
}

// åœ¨å·¥å…·ä¸­ä½¿ç”¨ï¼ˆéœ€è¦åœ¨ registerTool å¤–éƒ¨è®¿é—®ï¼‰
const token = extractTokenFromHeaders(req);
```

## ğŸ“‹ å®Œæ•´å¼€å‘æµç¨‹

### 1ï¸âƒ£ åˆå§‹åŒ–é¡¹ç›®

```bash
mkdir your-mcp-project
cd your-mcp-project
npm init -y
```

### 2ï¸âƒ£ å®‰è£…ä¾èµ–

```bash
# æ ¸å¿ƒä¾èµ–ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
npm install @modelcontextprotocol/sdk@^1.22.0 zod express cors dotenv

# å¼€å‘ä¾èµ–
npm install -D typescript @types/node @types/express @types/cors
```

### 3ï¸âƒ£ é…ç½® TypeScript

åˆ›å»º `tsconfig.json`ï¼š

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "Node16",
    "moduleResolution": "Node16",
    "outDir": "./build",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "build"]
}
```

### 4ï¸âƒ£ åˆ›å»ºå·¥å…·

åœ¨ `src/tools/` ç›®å½•ä¸‹åˆ›å»ºä½ çš„ä¸šåŠ¡å·¥å…·ã€‚

### 5ï¸âƒ£ åˆ›å»ºå…¥å£æ–‡ä»¶

- `src/index.ts` - stdio æ¨¡å¼å…¥å£
- `src/httpServer.ts` - HTTP æ¨¡å¼å…¥å£ï¼ˆå¯é€‰ï¼‰

### 6ï¸âƒ£ æ„å»ºé¡¹ç›®

```bash
npm run build
```

### 7ï¸âƒ£ æœ¬åœ°æµ‹è¯•

```bash
# stdio æ¨¡å¼æµ‹è¯•
npm run start:stdio

# HTTP æ¨¡å¼æµ‹è¯•
npm run start:http

# æµ‹è¯• health endpoint
curl http://localhost:3000/health
```

### 8ï¸âƒ£ å‘å¸ƒåˆ° npm

```bash
# ç™»å½• npm
npm login

# å‘å¸ƒ
npm publish
```

### 9ï¸âƒ£ é…ç½®å®¢æˆ·ç«¯

åœ¨ Claude Desktop æˆ–å…¶ä»– MCP å®¢æˆ·ç«¯ä¸­é…ç½®ï¼š

```json
{
  "mcpServers": {
    "your-mcp-server": {
      "command": "npx",
      "args": ["-y", "your-mcp-package"]
    }
  }
}
```

## ğŸ¯ è¿™å°±æ˜¯MCPä¸šåŠ¡å±‚çš„æ ¸å¿ƒæ„å»ºæ¨¡å¼ï¼

### å…³é”®è¦ç‚¹æ€»ç»“ï¼š

âœ… **æœ€æ–°åè®®**: 2025-06-18ï¼ˆæ›¿ä»£ 2024-11-05ï¼‰  
âœ… **æœ€æ–° SDK**: 1.22.0ï¼ˆæ›¿ä»£ 0.6.0ï¼‰  
âœ… **æ–° API**: McpServer + registerToolï¼ˆæ›¿ä»£ Server + setRequestHandlerï¼‰  
âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨ Zod è¿›è¡Œå‚æ•°éªŒè¯  
âœ… **è‡ªåŠ¨åŒ–**: StreamableHTTPServerTransport è‡ªåŠ¨å¤„ç†åè®®  
âœ… **stdio æ¨¡å¼**æ˜¯æœ¬åœ°ä½¿ç”¨çš„æœ€ä½³é€‰æ‹©ï¼ˆé›¶é…ç½®ã€ç®€å•ï¼‰  
âœ… **HTTP æ¨¡å¼**é€‚åˆæœåŠ¡å™¨éƒ¨ç½²å’Œå¤šç”¨æˆ·åœºæ™¯  
âœ… **package.json** çš„ `bin` å­—æ®µæ˜¯å®ç° `npx` è°ƒç”¨çš„å…³é”®  
âœ… **build è„šæœ¬**ä¸­çš„ `chmodSync` ä½¿æ–‡ä»¶å¯æ‰§è¡Œ  
âœ… ç¯å¢ƒå˜é‡é€šè¿‡å®¢æˆ·ç«¯é…ç½®çš„ `env` å­—æ®µä¼ é€’ï¼ˆstdio æ¨¡å¼ï¼‰  
âœ… è‡ªå®šä¹‰ Header é€šè¿‡å®¢æˆ·ç«¯é…ç½®çš„ `headers` å­—æ®µä¼ é€’ï¼ˆHTTP æ¨¡å¼ï¼‰  
âœ… ä½¿ç”¨ `as const` ç¡®ä¿è¿”å›ç±»å‹æ­£ç¡®  
âœ… `#!/usr/bin/env node` shebang åœ¨ index.ts å¼€å¤´æ˜¯å¿…é¡»çš„

## ğŸ†• æ–°ç‰ˆæœ¬ç‰¹æ€§

### 1. McpServer API
- æ›´ç®€æ´çš„åˆå§‹åŒ–
- è‡ªåŠ¨å·¥å…·ç®¡ç†
- æ›´å¥½çš„ç±»å‹æ”¯æŒ

### 2. registerTool
- ä¸€æ¬¡æ€§æ³¨å†Œå·¥å…·
- Zod schema éªŒè¯
- è‡ªåŠ¨ç”Ÿæˆå·¥å…·åˆ—è¡¨

### 3. StreamableHTTPServerTransport
- è‡ªåŠ¨å¤„ç† MCP åè®®
- å†…ç½®ä¼šè¯ç®¡ç†
- æ”¯æŒ GET/POST/DELETE

### 4. ç±»å‹å®‰å…¨
- Zod schema å®šä¹‰
- TypeScript ä¸¥æ ¼æ¨¡å¼
- `as const` ç±»å‹æ–­è¨€

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Invalid Host header

**é”™è¯¯**: `Invalid Host header: localhost:3000`

**è§£å†³**:
```typescript
enableDnsRebindingProtection: false,  // æœ¬åœ°å¼€å‘
```

### é—®é¢˜ 2: Type 'string' is not assignable to type '"text"'

**è§£å†³**:
```typescript
type: "text" as const,  // æ·»åŠ  as const
```

### é—®é¢˜ 3: å·¥å…·ä¸æ˜¾ç¤º

**æ£€æŸ¥**:
1. æ˜¯å¦ä½¿ç”¨ `registerTool`
2. server æ˜¯å¦æ­£ç¡® connect
3. æ£€æŸ¥å®¢æˆ·ç«¯é…ç½®

---

## ğŸ“ ä½œè€…ä¿¡æ¯

åœ¨åˆ›å»º README æˆ–å…¶ä»–æ–‡æ¡£æ—¶ï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹è”ç³»æ–¹å¼ï¼š

- **LinkedIn**: [https://www.linkedin.com/in/xingyu-chen-b5b3b0313/](https://www.linkedin.com/in/xingyu-chen-b5b3b0313/)
- **Email**: guangxiangdebizi@gmail.com
- **GitHub**: [https://github.com/guangxiangdebizi/](https://github.com/guangxiangdebizi/)
- **NPM**: [https://www.npmjs.com/~xingyuchen](https://www.npmjs.com/~xingyuchen)

## ğŸ“ é»˜è®¤è®¾ç½®

- **åè®®ç‰ˆæœ¬**: 2025-06-18ï¼ˆæœ€æ–°ï¼‰
- **SDK ç‰ˆæœ¬**: 1.22.0ï¼ˆæœ€æ–°ï¼‰
- **è¯­è¨€**: å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜ç¡®è¦æ±‚ä½¿ç”¨ä¸­æ–‡ï¼Œä¼˜å…ˆä½¿ç”¨è‹±è¯­ç¼–å†™ READMEã€æ–‡æ¡£å’Œ npm åŒ…æè¿°
- **å¼€æºåè®®**: é»˜è®¤ä½¿ç”¨ Apache 2.0 License
- **æ–‡æ¡£é£æ ¼**: æ³¨é‡ç¾è§‚æ€§å’Œå¯è¯»æ€§ï¼Œä½¿ç”¨è¡¨æƒ…ç¬¦å·ã€è¡¨æ ¼å’Œæ¸…æ™°çš„ç»“æ„
- **å‘å¸ƒæµç¨‹**: å®Œæˆå¼€å‘åååŠ©å‘å¸ƒåˆ° npm

## ğŸ”„ ä»æ—§ç‰ˆæœ¬å‡çº§

å¦‚æœä½ æœ‰ä½¿ç”¨æ—§ API çš„é¡¹ç›®ï¼Œè¯·å‚è€ƒå‡çº§æŒ‡å—ï¼š

1. æ›´æ–°ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
2. å°† `Server` æ›¿æ¢ä¸º `McpServer`
3. å°† `setRequestHandler` æ›¿æ¢ä¸º `registerTool`
4. æ·»åŠ  Zod schema
5. æ›´æ–°è¿”å›ç±»å‹ä½¿ç”¨ `as const`
6. æµ‹è¯•æ‰€æœ‰å·¥å…·åŠŸèƒ½

è¯¦ç»†å‡çº§æ­¥éª¤è¯·å‚è€ƒé¡¹ç›®ä¸­çš„ `UPGRADE_REPORT.md`ã€‚
